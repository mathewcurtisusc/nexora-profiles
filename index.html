<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nexora Profile</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f7;
    margin: 0;
    padding: 0;
    color: #222;
  }

  .page {
    max-width: 900px;
    margin: 40px auto;
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 32px 40px;
  }

  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 24px;
    margin-bottom: 24px;
  }

  .header img {
    width: 180px;
    height: 180px;
    object-fit: cover;
    border-radius: 4px;
  }
  .photo-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}


  .title-block h1 {
    margin: 0;
    font-size: 26px;
  }

  .header img.default-image {
  object-fit: contain;
  background-color: #f5f5f7;
}

.photo-note {
  font-size: 11px;
  color: #888;
  margin-top: 6px;
  text-align: center;
}

  .title-block h2 {
    margin: 4px 0 8px 0;
    font-size: 16px;
    font-weight: normal;
    color: #666;
  }

  .company {
    font-size: 13px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #999;
  }

  .section-title {
    margin-top: 18px;
    margin-bottom: 8px;
    font-size: 14px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #555;
  }

  p {
    line-height: 1.5;
    font-size: 14px;
    margin: 0 0 12px 0;
  }
/* Cap container next to student name */
.cap-container {
  display: flex;
  align-items: center;
  margin-left: 24px;   /* keeps it near the name */
  gap: 12px;
}

/* Force both caps to fill identical box */
.header > .cap-container > img.cap-icon {
  width: 110px;           /* adjust if you want bigger/smaller */
  height: 85px;
  object-fit: cover;      /* THIS makes them visually the same size */
  object-position: center;
  border-radius: 6px;
  display: block;
  max-width: none;
}
</style>

</head>
<body>

  <div class="page">
<div id="error-message" style="display:none;">
  <h1>Profile not found</h1>
  <p>
    The team ID in the link is missing or invalid.
    Please check the URL or contact your instructor.
  </p>
</div>

  <div class="header">
  <div class="photo-container">
    <img id="profile-image" alt="Profile image">
  </div>
  <div class="title-block">

      <h1 id="profile-name">Loading...</h1>
      <h2 id="profile-role"></h2>
      <span class="company">Nexora</span>
    </div>
  </div>

   <section id="background-section">
    <h3 class="section-title">Background</h3>
    <p id="profile-background"></p>
  </section>

  <section id="style-section">
    <h3 class="section-title">Leadership Style</h3>
    <p id="profile-style"></p>
  </section>

  <section id="interests-section" style="display:none;">
    <h3 class="section-title">Personal Interests</h3>
    <p id="profile-interests"></p>
  </section>

</div>

<script>
  const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vS2wW-ulUPyRcOy_xPMnzy0AxudKP-4RFYoZYMzTWAqMqTZvrtH1e1SiI183163SUkiGF2EM1CHlihQ/pub?output=csv";  
  // Read team ID from URL, e.g. ?id=team01
  const params = new URLSearchParams(window.location.search);
  const TARGET_ID = params.get("id");
  const NORMALIZED_TARGET_ID = TARGET_ID
  ? TARGET_ID.trim().toLowerCase()
  : null;


 if (!TARGET_ID) {
  showError("No team ID was provided in the URL.");
  throw new Error("Missing ?id= parameter");
}
function showError(message) {
  document.querySelector(".header").style.display = "none";
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  const errorDiv = document.getElementById("error-message");
  errorDiv.style.display = "block";
  errorDiv.querySelector("p").innerText = message;
}


  fetch(SHEET_URL)
    .then(response => response.text())
    .then(csv => {
      const rows = csv
        .trim()
        .split("\n")
        .map(row =>
          row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell =>
            cell.replace(/^"|"$/g, "").trim()
          )
        );

      const headers = rows[0];
const cleanHeaders = headers.map(h => h.replace(/\r/g, ""));

     const idIndex = cleanHeaders.indexOf("Assigned Nexora ID");
const nameIndex = cleanHeaders.indexOf("Display Name");
const roleIndex = cleanHeaders.indexOf("Role / Title");
const backgroundIndex = cleanHeaders.indexOf("Professional Background");
const styleIndex = cleanHeaders.indexOf("Leadership / Decision Style");
const interestsIndex = cleanHeaders.indexOf("Personal");
const imageIndex = cleanHeaders.indexOf("Nexora Profile Image");
const idStatusIndex = cleanHeaders.indexOf("ID_Status");

const lockIndex = cleanHeaders.indexOf("Submission Locked");
const normalizedIdIndex = cleanHeaders.indexOf("Normalized Nexora ID");

      if (normalizedIdIndex === -1) {
  showError(
    "Configuration error: Required column 'Normalized Nexora ID' was not found."
  );
  throw new Error("Missing Normalized Nexora ID column");
}

      let duplicateFound = false;

console.log("ID_Status index:", idStatusIndex);

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
if (
  row[normalizedIdIndex]?.trim().toLowerCase() === NORMALIZED_TARGET_ID &&
  row[idStatusIndex] === "DUPLICATE"
) {
  duplicateFound = true;
}



if (
  row[normalizedIdIndex]?.trim().toLowerCase() === NORMALIZED_TARGET_ID &&
  row[idStatusIndex] === "OK"
) {


          // Name
          document.getElementById("profile-name").innerText = row[nameIndex] || "";

          // Role
          document.getElementById("profile-role").innerText = row[roleIndex] || "";

         // Background
if (row[backgroundIndex]) {
  document.getElementById("profile-background").innerText = row[backgroundIndex];
  document.getElementById("background-section").style.display = "block";
} else {
  document.getElementById("background-section").style.display = "none";
}



       // Leadership style
if (row[styleIndex]) {
  document.getElementById("profile-style").innerText = row[styleIndex];
  document.getElementById("style-section").style.display = "block";
} else {
  document.getElementById("style-section").style.display = "none";
}

// Personal interests
if (row[interestsIndex]) {
  document.getElementById("profile-interests").innerText = row[interestsIndex];
  document.getElementById("interests-section").style.display = "block";
} else {
  document.getElementById("interests-section").style.display = "none";
}

// Profile image (clean, stable logic)
const imageElement = document.getElementById("profile-image");
const fallbackImage = "/nexora-profiles/images/logo.png";

// reset any previous handlers
imageElement.onload = null;
imageElement.onerror = null;

// helper for default state
function showDefaultImage() {
  imageElement.src = fallbackImage;
  imageElement.classList.add("default-image");

  const existingNote =
    imageElement.parentElement.querySelector(".photo-note");

  if (!existingNote) {
    const note = document.createElement("div");
    note.className = "photo-note";
    note.innerText = "No photo provided";
imageElement.parentElement.appendChild(note);
  }
}

// start with default
showDefaultImage();

const imageCell = row[imageIndex];

if (imageCell) {
  const match = imageCell.match(/id=([a-zA-Z0-9_-]+)/);

  if (match) {
    const fileId = match[1];
    const driveImageUrl =
      `https://lh3.googleusercontent.com/d/${fileId}`;

    imageElement.onload = () => {
      imageElement.classList.remove("default-image");
      const note =
        imageElement.parentElement.querySelector(".photo-note");
      if (note) note.remove();
    };

    imageElement.onerror = () => {
      showDefaultImage();
    };

    imageElement.src = driveImageUrl;
    // --- BEGIN: cap choice display (right of name/role) ---
const capChoiceIndex = cleanHeaders.findIndex(h => h.trim().toLowerCase() === "cap choice");

if (capChoiceIndex !== -1) {
  const rawChoice = (row[capChoiceIndex] || "").trim().toLowerCase();

  const capMap = {
    "cardinal": "https://raw.githubusercontent.com/mathewcurtisusc/nexora-profiles/main/images/cardinal.png",
    "gold":     "https://raw.githubusercontent.com/mathewcurtisusc/nexora-profiles/main/images/gold.png"
  };

  // Remove any existing cap container to avoid duplicates
  const prev = document.getElementById("cap-container");
  if (prev) prev.remove();

  if (capMap[rawChoice]) {
    // Build container and img
    const capContainer = document.createElement("div");
    capContainer.id = "cap-container";
    capContainer.className = "cap-container";

    const capImg = document.createElement("img");
    capImg.src = capMap[rawChoice];
    capImg.alt = rawChoice + " cap";
    capImg.loading = "lazy";
    capImg.classList.add("cap-icon");

    capContainer.appendChild(capImg);

    // Append as third child of .header so flex pushes it to the right
    const headerEl = document.querySelector(".header");
    if (headerEl) headerEl.appendChild(capContainer);
  }
}
// --- END: cap choice display ---
  }
}





return;
}
}

if (duplicateFound) {
  showError(
    "This profile is temporarily unavailable because the assigned Nexora ID is duplicated. " +
    "Please double-check your assigned ID in the form and resubmit, or contact your instructor if you believe this is an error."
  );
} else {
  showError(`No profile found for team ID "${TARGET_ID}".`);
}



    })
    .catch(err => {
  console.error(err);
  showError("An unexpected error occurred while loading this profile.");
});

</script>

</body>
</html>







